<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="探究Android开发技术">
    <meta name="author" content="cfanr">
    
    <title>
        
            Android NDK开发：JNI实战篇 |
        
        cfanr&#39;s Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.png">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"navyifanr.github.io","root":"/","language":"en"};
    KEEP.theme_config = {"toc":{"enable":false,"number":false,"expand_all":false,"init_open":false},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.svg","favicon":"/images/logo.png","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":false,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving."},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":false}}},"local_search":{"enable":false,"preload":false},"code_copy":{"enable":false,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                cfanr&#39;s Blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                    
                </ul>
            </div>
            <div class="mobile">
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">Android NDK开发：JNI实战篇</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.svg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">cfanr</span>
                        
                            <span class="author-label">Lv4</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2017-08-05 09:11:21</span>
        <span class="mobile">2017-08-05 09:11</span>
    </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/Android-NDK/">Android NDK</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <p>紧接上篇：<a class="link"   target="_blank" rel="noopener" href="http://cfanr.cn/2017/07/29/Android-NDK-dev-JNI-s-foundation/" >Android NDK开发：JNI基础篇 | cfanr<i class="fas fa-external-link-alt"></i></a>，这篇主要介绍 JNI Native 层调用Java 层的代码（涉及JNI 数据类型映射和描述符的使用）和如何动态注册 JNI。 </p>
<h2 id="1-Hello-World-NDK"><a href="#1-Hello-World-NDK" class="headerlink" title="1. Hello World NDK"></a>1. Hello World NDK</h2><p> 在开始实战练习前，你需要先大致了解运行一个 Hello World 的项目大概需要做什么，有哪些配置以及配置的具体意思。 <strong>Android Studio(2.2以上版本)提供两种方式编译原生库：CMake( 默认方式) 和 ndk-build</strong>。对于初学者可以先了解 CMake 的方式，另外，对于本文可以暂时不用了解 so 库如何编译和使用。</p>
<p>一个 Hello World 的 NDK 项目很简单，按照流程新建一个 native 库工程就可以，由于太简单，而且网上也有很多教程，这里就没必要浪费时间再用图文介绍了。详细操作方法，可以参考这篇文章，<a class="link"   target="_blank" rel="noopener" href="http://blog.csdn.net/yulianlin/article/details/53168350" >AS2.2使用CMake方式进行JNI&#x2F;NDK开发-于连林- CSDN博客<i class="fas fa-external-link-alt"></i></a></p>
<p>列出项目中涉及 NDK 的内容或配置几点需要注意的地方：</p>
<ul>
<li>.externalNativeBuild 文件是 CMake 编译好的文件，显示支持的各种硬件平台的信息，如 ARM、x86等；</li>
<li>cpp 文件是放置 native  文件的地方，名字可以修改成其他的（只要里面函数名字对应Java native 方法就好）；</li>
<li>CMakeLists.txt，AS自动生成的 CMake 脚本配置文件</li>
</ul>
<span id="more"></span>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># value of 3.4.0 or lower.</span><br><span class="line"></span><br><span class="line"># 1.指定cmake版本</span><br><span class="line">cmake_minimum_required(VERSION 3.4.1)</span><br><span class="line"></span><br><span class="line">add_library( # Sets the name of the library. ——&gt;2.生成函数库的名字，需要写到程序中的 so 库的名字</span><br><span class="line">             native-lib</span><br><span class="line"></span><br><span class="line">             # Sets the library as a shared library. 生成动态函数</span><br><span class="line">             SHARED</span><br><span class="line"></span><br><span class="line">             # Provides a relative path to your source file(s).</span><br><span class="line">             # Associated headers in the same location as their source</span><br><span class="line">             # file are automatically included.  ——&gt; 依赖的cpp文件，每添加一个 C/C++文件都要添加到这里，不然不会被编译</span><br><span class="line">             src/main/cpp/native-lib.cpp</span><br><span class="line">             )</span><br><span class="line"></span><br><span class="line">find_library( # Sets the name of the path variable. 设置path变量的名称</span><br><span class="line">              log-lib</span><br><span class="line"></span><br><span class="line">              # Specifies the name of the NDK library that</span><br><span class="line">              # you want CMake to locate. #指定要查询库的名字</span><br><span class="line">              log )</span><br><span class="line"></span><br><span class="line"># Specifies libraries CMake should link to your target library. You</span><br><span class="line"># can link multiple libraries, such as libraries you define in the</span><br><span class="line"># build script, prebuilt third-party libraries, or system libraries.</span><br><span class="line"></span><br><span class="line">target_link_libraries( # Specifies the target library.  目标库, 和上面生成的函数库名字一致</span><br><span class="line">                       native-lib</span><br><span class="line"></span><br><span class="line">                       # Links the target library to the log library</span><br><span class="line">                       # included in the NDK.  连接的库，根据log-lib变量对应liblog.so函数库</span><br><span class="line">                       $&#123;log-lib&#125; )</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>build.gradle 文件，注意两个 <code>externalNativeBuild &#123;&#125;</code>的配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">&#x27;com.android.application&#x27;</span></span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion <span class="number">25</span></span><br><span class="line">    buildToolsVersion <span class="string">&quot;25.0.2&quot;</span></span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        applicationId <span class="string">&quot;cn.cfanr.jnisample&quot;</span></span><br><span class="line">        minSdkVersion <span class="number">15</span></span><br><span class="line">        targetSdkVersion <span class="number">25</span></span><br><span class="line">        versionCode <span class="number">1</span></span><br><span class="line">        versionName <span class="string">&quot;1.0&quot;</span></span><br><span class="line">        testInstrumentationRunner <span class="string">&quot;android.support.test.runner.AndroidJUnitRunner&quot;</span></span><br><span class="line">        externalNativeBuild &#123;</span><br><span class="line">            cmake &#123;</span><br><span class="line">                cppFlags <span class="string">&quot;&quot;</span>  <span class="comment">//如果使用 C++11 标准，则改为 &quot;-std=c++11&quot;    </span></span><br><span class="line">                <span class="comment">// 生成.so库的目标平台，使用的是genymotion模拟器，需要加上 x86</span></span><br><span class="line">                abiFilters <span class="string">&quot;armeabi-v7a&quot;</span>, <span class="string">&quot;armeabi&quot;</span>, <span class="string">&quot;x86&quot;</span>       </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="literal">false</span></span><br><span class="line">            proguardFiles <span class="title function_">getDefaultProguardFile</span><span class="params">(<span class="string">&#x27;proguard-android.txt&#x27;</span>)</span>, <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    externalNativeBuild &#123;</span><br><span class="line">        cmake &#123;</span><br><span class="line">            path <span class="string">&quot;CMakeLists.txt&quot;</span>  <span class="comment">//配置 CMake 文件的路径</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>local.properties 文件会多了 ndk 路径的配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ndk.dir=/Users/cfanr/Library/Android/sdk/ndk-bundle</span><br><span class="line">sdk.dir=/Users/cfanr/Library/Android/sdk</span><br></pre></td></tr></table></figure>

<p>MainActivity 调用 so 库</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="comment">// Used to load the &#x27;native-lib&#x27; library on application startup.</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;native-lib&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	  <span class="comment">//……</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外，还需要回顾上篇 JNI 基础篇-静态注册也提到 JNI 的函数命名规则：<code>JNIEXPORT 返回值 JNICALL Java_全路径类名_方法名_参数签名(JNIEnv* , jclass, 其它参数);</code><strong>其中第二个参数，当 java native 方法是 static 时，为 jclass，当为非静态方法时，为 jobject</strong>，为了简单起见，下面的例子 JNI 函数都标记<code>extern &quot;C&quot;</code>，函数名就不需要写参数签名了</p>
<h2 id="2-JNI-函数访问-Java-对象的变量"><a href="#2-JNI-函数访问-Java-对象的变量" class="headerlink" title="2. JNI 函数访问 Java 对象的变量"></a>2. JNI 函数访问 Java 对象的变量</h2><p><em>注：以下练习中 Java native 方法都是非静态的</em><br>步骤：</p>
<ul>
<li>1）通过<code>env-&gt;GetObjectClass(jobject)</code>获取Java 对象的 class 类，返回一个 jclass；</li>
<li>2）调用<code>env-&gt;GetFieldID(jclazz, fieldName, signature)</code>得到该实例域（变量）的 id，即 jfieldID；如果变量是静态 static 的，则调用的方法为 <code>GetStaticFieldID</code></li>
<li>3）最后通过调用<code>env-&gt;Get&#123;type&#125;Field(jobject, fieldId)</code> 得到该变量的值。其中{type} 是变量的类型；如果变量是静态 static  的，则调用的方法是<code>GetStatic&#123;type&#125;Field(jclass, fieldId)</code>，注意 static 的话， 是使用 jclass 作为参数；</li>
</ul>
<h4 id="2-1-访问某个变量，并通过某个方法对其处理后返回"><a href="#2-1-访问某个变量，并通过某个方法对其处理后返回" class="headerlink" title="2.1 访问某个变量，并通过某个方法对其处理后返回"></a>2.1 访问某个变量，并通过某个方法对其处理后返回</h4><p>native方法定义和调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">addNum</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">FieldJni</span> <span class="variable">fieldJni</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FieldJni</span>();</span><br><span class="line">Log.e(TAG, <span class="string">&quot;调用前：num = &quot;</span> + fieldJni.num);</span><br><span class="line">Log.e(TAG, <span class="string">&quot;调用后：&quot;</span> + fieldJni.addNum());</span><br></pre></td></tr></table></figure>

<p>C++层：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line"><span class="function">JNIEXPORT jint JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_cn_cfanr_jnisample_FieldJni_addNum</span><span class="params">(JNIEnv *env, jobject jobj)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取实例对应的 class</span></span><br><span class="line">    jclass jclazz = env-&gt;<span class="built_in">GetObjectClass</span>(jobj);</span><br><span class="line">    <span class="comment">//通过class获取相应的变量的 field id</span></span><br><span class="line">    jfieldID fid = env-&gt;<span class="built_in">GetFieldID</span>(jclazz, <span class="string">&quot;num&quot;</span>, <span class="string">&quot;I&quot;</span>);</span><br><span class="line">    <span class="comment">//通过 field id 获取对应的值</span></span><br><span class="line">    jint num = env-&gt;<span class="built_in">GetIntField</span>(jobj, fid);  <span class="comment">//注意，不是用 jclazz, 使用 jobj</span></span><br><span class="line">    num++;</span><br><span class="line">    <span class="keyword">return</span> num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MainActivity: 调用前：num = <span class="number">10</span></span><br><span class="line">MainActivity: 调用后：<span class="number">11</span></span><br></pre></td></tr></table></figure>
<p>由于 jclass 也是继承 jobject，所以使用 GetIntField 时不要混淆两个参数</p>
<h4 id="2-2-访问一个-static-变量，并对其修改"><a href="#2-2-访问一个-static-变量，并对其修改" class="headerlink" title="2.2 访问一个 static 变量，并对其修改"></a>2.2 访问一个 static 变量，并对其修改</h4><p>native方法定义和调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;cfanr&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">accessStaticField</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">//调用</span></span><br><span class="line">Log.e(TAG, <span class="string">&quot;调用前：name = &quot;</span> + fieldJni.name);</span><br><span class="line">fieldJni.accessStaticField();</span><br><span class="line">Log.e(TAG, <span class="string">&quot;调用后：&quot;</span> + fieldJni.name);</span><br></pre></td></tr></table></figure>

<p>C++代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="type">void</span> JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_cn_cfanr_jnisample_FieldJni_accessStaticField</span><span class="params">(JNIEnv *env, jobject jobj)</span> </span>&#123;</span><br><span class="line">    jclass jclazz = env-&gt;<span class="built_in">GetObjectClass</span>(jobj);</span><br><span class="line">    jfieldID fid = env-&gt;<span class="built_in">GetStaticFieldID</span>(jclazz, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;Ljava/lang/String;&quot;</span>);  <span class="comment">//注意是用GetStaticFieldID，不是GetFieldID</span></span><br><span class="line">    jstring name = (jstring) env-&gt;<span class="built_in">GetStaticObjectField</span>(jclazz, fid);</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* str = env-&gt;<span class="built_in">GetStringUTFChars</span>(name, JNI_FALSE);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 不要用 == 比较字符串</span></span><br><span class="line"><span class="comment">     * name == (jstring) &quot;cfanr&quot;</span></span><br><span class="line"><span class="comment">     * 或用 = 直接赋值</span></span><br><span class="line"><span class="comment">     * name = (jstring) &quot;navy&quot;</span></span><br><span class="line"><span class="comment">     * 警告：warning: result of comparison against a string literal is unspecified (use strncmp instead) [-Wstring-compare]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">char</span> ch[<span class="number">30</span>] = <span class="string">&quot;hello, &quot;</span>;</span><br><span class="line">    <span class="built_in">strcat</span>(ch, str);</span><br><span class="line">    jstring new_str = env-&gt;<span class="built_in">NewStringUTF</span>(ch);</span><br><span class="line">    <span class="comment">// 将jstring类型的变量，设置到java</span></span><br><span class="line">    env-&gt;<span class="built_in">SetStaticObjectField</span>(jclazz, fid, new_str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MainActivity: 调用前：name = cfanr</span><br><span class="line">MainActivity: 调用后：hello, cfanr</span><br></pre></td></tr></table></figure>
<p>需要注意的是，获取 java 静态变量，都是调用 JNI 相应静态的函数，不能调用非静态的，同时留意传入的参数是 jclass，而不是 jobject</p>
<h4 id="2-3-访问一个-private-变量，并对其修改"><a href="#2-3-访问一个-private-变量，并对其修改" class="headerlink" title="2.3 访问一个 private 变量，并对其修改"></a>2.3 访问一个 private 变量，并对其修改</h4><p>native方法定义和调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">age</span> <span class="operator">=</span> <span class="number">21</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">accessPrivateField</span><span class="params">()</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> age;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//调用</span></span><br><span class="line">Log.e(TAG, <span class="string">&quot;调用前：age = &quot;</span> + fieldJni.getAge());</span><br><span class="line">fieldJni.accessPrivateField();</span><br><span class="line">Log.e(TAG, <span class="string">&quot;调用后：age = &quot;</span> + fieldJni.getAge());</span><br></pre></td></tr></table></figure>
<p>C++:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="type">void</span> JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_cn_cfanr_jnisample_FieldJni_accessPrivateField</span><span class="params">(JNIEnv *env, jobject jobj)</span> </span>&#123;</span><br><span class="line">    jclass clazz = env-&gt;<span class="built_in">GetObjectClass</span>(jobj);</span><br><span class="line"></span><br><span class="line">    jfieldID fid = env-&gt;<span class="built_in">GetFieldID</span>(clazz, <span class="string">&quot;age&quot;</span>, <span class="string">&quot;I&quot;</span>);</span><br><span class="line"></span><br><span class="line">    jint age = env-&gt;<span class="built_in">GetIntField</span>(jobj, fid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(age &gt; <span class="number">18</span>) &#123;</span><br><span class="line">        age = <span class="number">18</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        age--;</span><br><span class="line">    &#125;</span><br><span class="line">    env-&gt;<span class="built_in">SetIntField</span>(jobj, fid, age);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MainActivity: 调用前：age = <span class="number">21</span></span><br><span class="line">MainActivity: 调用后：age = <span class="number">18</span></span><br></pre></td></tr></table></figure>

<h2 id="3-JNI-函数调用-Java-对象的方法"><a href="#3-JNI-函数调用-Java-对象的方法" class="headerlink" title="3. JNI 函数调用 Java 对象的方法"></a>3. JNI 函数调用 Java 对象的方法</h2><p>步骤：（和访问 Java 对象的变量有点类型）</p>
<ul>
<li>1）通过<code>env-&gt;GetObjectClass(jobject)</code>获取Java 对象的 class 类，返回一个 jclass；</li>
<li>2）通过<code>env-&gt;GetMethodID(jclass, methodName, sign)</code>获取到 Java 对象的方法 Id，即 jmethodID，当获取的方法是 static 的时，使用<code>GetStaticMethodID</code>;</li>
<li>3）通过 JNI 函数<code>env-&gt;Call&#123;type&#125;Method(jobject, jmethod, param...)</code>实现调用 Java的方法；若调用的是 static 方法，则使用<code>CallStatic&#123;type&#125;Method(jclass, jmethod, param...)</code>，使用的是 jclass</li>
</ul>
<h4 id="3-1-调用-Java-公有方法"><a href="#3-1-调用-Java-公有方法" class="headerlink" title="3.1 调用 Java 公有方法"></a>3.1 调用 Java 公有方法</h4><p>native方法定义和调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">sex</span> <span class="operator">=</span> <span class="string">&quot;female&quot;</span>;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSex</span><span class="params">(String sex)</span> &#123;</span><br><span class="line">     <span class="built_in">this</span>.sex = sex;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">public</span> String <span class="title function_">getSex</span><span class="params">()</span>&#123;</span><br><span class="line">     <span class="keyword">return</span> sex;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">accessPublicMethod</span><span class="params">()</span>;</span><br><span class="line"> <span class="comment">//调用</span></span><br><span class="line"> <span class="type">MethodJni</span> <span class="variable">methodJni</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MethodJni</span>();</span><br><span class="line"> Log.e(TAG, <span class="string">&quot;调用前：getSex() = &quot;</span> + methodJni.getSex());</span><br><span class="line"> methodJni.accessPublicMethod();</span><br><span class="line"> Log.e(TAG, <span class="string">&quot;调用后：getSex() = &quot;</span> + methodJni.getSex());</span><br></pre></td></tr></table></figure>
<p>C++</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="type">void</span> JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_cn_cfanr_jnisample_MethodJni_accessPublicMethod</span><span class="params">(JNIEnv *env, jobject jobj)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1.获取对应 class 的实体类</span></span><br><span class="line">    jclass jclazz = env-&gt;<span class="built_in">GetObjectClass</span>(jobj);</span><br><span class="line">    <span class="comment">//2.获取方法的 id</span></span><br><span class="line">    jmethodID mid = env-&gt;<span class="built_in">GetMethodID</span>(jclazz, <span class="string">&quot;setSex&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>);</span><br><span class="line">    <span class="comment">//3.字符数组转换为字符串</span></span><br><span class="line">    <span class="type">char</span> c[<span class="number">10</span>] = <span class="string">&quot;male&quot;</span>;</span><br><span class="line">    jstring jsex = env-&gt;<span class="built_in">NewStringUTF</span>(c);</span><br><span class="line">    <span class="comment">//4.通过该 class 调用对应的 public 方法</span></span><br><span class="line">    env-&gt;<span class="built_in">CallVoidMethod</span>(jobj, mid, jsex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MainActivity: 调用前：getSex() = female</span><br><span class="line">MainActivity: 调用后：getSex() = male</span><br></pre></td></tr></table></figure>
<p>调用 java private 方法也是类似， Java 的访问域修饰符对 C++无效</p>
<h4 id="3-2-调用-Java-静态方法"><a href="#3-2-调用-Java-静态方法" class="headerlink" title="3.2 调用 Java 静态方法"></a>3.2 调用 Java 静态方法</h4><p>native方法定义和调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> <span class="number">170</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getHeight</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> height;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">accessStaticMethod</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">//调用</span></span><br><span class="line">Log.e(TAG, <span class="string">&quot;调用静态方法：getHeight() = &quot;</span> + methodJni.accessStaticMethod());</span><br></pre></td></tr></table></figure>
<p>C++</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line"><span class="function">JNIEXPORT jint JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_cn_cfanr_jnisample_MethodJni_accessStaticMethod</span><span class="params">(JNIEnv *env, jobject jobj)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1.获取对应 class 实体类</span></span><br><span class="line">    jclass jclazz = env-&gt;<span class="built_in">GetObjectClass</span>(jobj);</span><br><span class="line">    <span class="comment">//2.通过 class 类找到对应的方法 id</span></span><br><span class="line">    jmethodID mid = env-&gt;<span class="built_in">GetStaticMethodID</span>(jclazz, <span class="string">&quot;getHeight&quot;</span>, <span class="string">&quot;()I&quot;</span>);  <span class="comment">//注意静态方法是调用GetStaticMethodID, 不是GetMethodID</span></span><br><span class="line">    <span class="comment">//3.通过 class 调用对应的静态方法</span></span><br><span class="line">    <span class="keyword">return</span> env-&gt;<span class="built_in">CallStaticIntMethod</span>(jclazz, mid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：<br><code>MainActivity: 调用静态方法：getHeight() = 170</code></p>
<p>注意调用的静态方法要一致。</p>
<h4 id="3-3-调用-Java-父类方法"><a href="#3-3-调用-Java-父类方法" class="headerlink" title="3.3 调用 Java 父类方法"></a>3.3 调用 Java 父类方法</h4><p>native方法定义和调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SuperJni</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;welcome to JNI world, &quot;</span> + name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MethodJni</span> <span class="keyword">extends</span> <span class="title class_">SuperJni</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">accessSuperMethod</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//调用</span></span><br><span class="line">Log.e(TAG, <span class="string">&quot;调用父类方法：hello(name) = &quot;</span> + methodJni.accessSuperMethod());</span><br></pre></td></tr></table></figure>
<p>C++</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line"><span class="function">JNIEXPORT jstring JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_cn_cfanr_jnisample_MethodJni_accessSuperMethod</span><span class="params">(JNIEnv *env, jobject jobj)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1.通过反射获取 class 实体类</span></span><br><span class="line">    jclass jclazz = env-&gt; <span class="built_in">FindClass</span>(<span class="string">&quot;cn/cfanr/jnisample/SuperJni&quot;</span>);  <span class="comment">//注意 FindClass 不要 L和;</span></span><br><span class="line">    <span class="keyword">if</span>(jclazz == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="type">char</span> c[<span class="number">10</span>] = <span class="string">&quot;error&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> env-&gt;<span class="built_in">NewStringUTF</span>(c);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//通过 class 找到对应的方法 id</span></span><br><span class="line">    jmethodID mid = env-&gt;<span class="built_in">GetMethodID</span>(jclazz, <span class="string">&quot;hello&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)Ljava/lang/String;&quot;</span>);</span><br><span class="line">    <span class="type">char</span> ch[<span class="number">10</span>] = <span class="string">&quot;cfanr&quot;</span>;</span><br><span class="line">    jstring jstr = env-&gt;<span class="built_in">NewStringUTF</span>(ch);</span><br><span class="line">    <span class="keyword">return</span> (jstring) env-&gt;<span class="built_in">CallNonvirtualObjectMethod</span>(jobj, jclazz, mid, jstr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意两点不同的地方，</p>
<ul>
<li>获取的是父类的方法，所以不能通过GetObjectClass获取，需要通过反射 FindClass 获取；</li>
<li>调用父类的方法是 CallNonvirtual{type}Method 函数。Nonvirtual是非虚拟函数</li>
</ul>
<h2 id="4-Java-方法传递参数给-JNI-函数"><a href="#4-Java-方法传递参数给-JNI-函数" class="headerlink" title="4. Java 方法传递参数给 JNI 函数"></a>4. Java 方法传递参数给 JNI 函数</h2><p>native 方法既可以传递基本类型参数给 JNI（可以不经过转换直接使用），也可以传递复杂的类型（需要转换为 C&#x2F;C++ 的数据结构才能使用），如数组，String 或自定义的类等。<br>基础类型，这里就不举例子了，详细可以看 GitHub 上的源码： <a class="link"   target="_blank" rel="noopener" href="https://github.com/navyifanr/AndroidTrainingDemo/tree/master/JNISample" >AndroidTrainingDemo&#x2F;JNISample<i class="fas fa-external-link-alt"></i></a><br>要用到的 JNI 函数：</p>
<ul>
<li>获取数组长度：<code>GetArrayLength(j&#123;type&#125;Array)</code>，type 为基础类型；</li>
<li>数组转换为对应类型的指针：<code>Get&#123;type&#125;ArrayElements(jarr, 0)</code></li>
<li>获取构造函数的 jmethodID 时，仍然是用<code>env-&gt;GetMethodID(jclass, methodName, sign)</code>获取，方法 name 是<init>；</li>
<li>通过构造函数 new 一个 jobject，<code>env-&gt;NewObject(jclass, constructorMethodID, param...)</code>，无参构造函数 param 则为空</li>
</ul>
<h4 id="4-1-数组参数的传递"><a href="#4-1-数组参数的传递" class="headerlink" title="4.1 数组参数的传递"></a>4.1 数组参数的传递</h4><p>计算整型数组参数的和<br>native方法定义和调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">intArrayMethod</span><span class="params">(<span class="type">int</span>[] arr)</span>;</span><br><span class="line"><span class="comment">//调用</span></span><br><span class="line"><span class="type">ParamsJni</span> <span class="variable">paramsJni</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ParamsJni</span>();</span><br><span class="line">Log.e(TAG, <span class="string">&quot;intArrayMethod: &quot;</span> + paramsJni.intArrayMethod(<span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">4</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">16</span>&#125;)+<span class="string">&quot;&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>C++</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line"><span class="function">JNIEXPORT jint JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_cn_cfanr_jnisample_ParamsJni_intArrayMethod</span><span class="params">(JNIEnv *env, jobject jobj, jintArray arr_)</span> </span>&#123;</span><br><span class="line">    jint len = <span class="number">0</span>, sum = <span class="number">0</span>;</span><br><span class="line">    jint *arr = env-&gt;<span class="built_in">GetIntArrayElements</span>(arr_, <span class="number">0</span>);</span><br><span class="line">    len = env-&gt;<span class="built_in">GetArrayLength</span>(arr_);</span><br><span class="line">    <span class="comment">//由于一些版本不兼容，i不定义在for循环中</span></span><br><span class="line">    jint i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(; i &lt; len; i++) &#123;</span><br><span class="line">        sum += arr[i];</span><br><span class="line">    &#125;</span><br><span class="line">    env-&gt;<span class="built_in">ReleaseIntArrayElements</span>(arr_, arr, <span class="number">0</span>);  <span class="comment">//释放内存</span></span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：<br><code>MainActivity: intArrayMethod: 39</code></p>
<h4 id="4-2-自定义对象参数的传递"><a href="#4-2-自定义对象参数的传递" class="headerlink" title="4.2 自定义对象参数的传递"></a>4.2 自定义对象参数的传递</h4><p>Person 定义，native方法定义和调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(<span class="type">int</span> age, String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person :&#123; name: &quot;</span>+name+<span class="string">&quot;, age: &quot;</span>+age+<span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//传递复杂对象person，再jni函数中新构造一个person传回java层输出</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> Person <span class="title function_">objectMethod</span><span class="params">(Person person)</span>;</span><br><span class="line"><span class="comment">//调用</span></span><br><span class="line">Log.e(TAG, <span class="string">&quot;objectMethod: &quot;</span> + paramsJni.objectMethod(<span class="keyword">new</span> <span class="title class_">Person</span>()).toString() + <span class="string">&quot;&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>C++:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line"><span class="function">JNIEXPORT jobject JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_cn_cfanr_jnisample_ParamsJni_objectMethod</span><span class="params">(JNIEnv *env, jobject jobj, jobject person)</span> </span>&#123;</span><br><span class="line">    jclass clazz = env-&gt;<span class="built_in">GetObjectClass</span>(person);  <span class="comment">//注意是用 person，不是 jobj</span></span><br><span class="line"><span class="comment">//    jclass jclazz = env-&gt;FindClass(&quot;cn/cfanr/jnisample/model/Person;&quot;);  //或者通过反射获取</span></span><br><span class="line">    <span class="keyword">if</span>(clazz == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> env-&gt;<span class="built_in">NewStringUTF</span>(<span class="string">&quot;cannot find class&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取方法 id</span></span><br><span class="line">    jmethodID constructorMid = env-&gt;<span class="built_in">GetMethodID</span>(clazz, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(ILjava/lang/String;)V&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(constructorMid == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> env-&gt;<span class="built_in">NewStringUTF</span>(<span class="string">&quot;not find constructor method&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    jstring name = env-&gt;<span class="built_in">NewStringUTF</span>(<span class="string">&quot;cfanr&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> env-&gt;<span class="built_in">NewObject</span>(clazz, constructorMid, <span class="number">21</span>, name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果<br><code>MainActivity: objectMethod: Person :&#123; name: cfanr, age: 21&#125;</code></p>
<p>注意：<strong>传递对象时，获取的 jclass 是获取该参数对象的 jobject 获取，而不是第二个参数（定义该 native 方法的对象）取；</strong></p>
<h4 id="4-3-自定义对象的集合参数的传递"><a href="#4-3-自定义对象的集合参数的传递" class="headerlink" title="4.3 自定义对象的集合参数的传递"></a>4.3 自定义对象的集合参数的传递</h4><p>native方法定义和调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> ArrayList&lt;Person&gt; <span class="title function_">personArrayListMethod</span><span class="params">(ArrayList&lt;Person&gt; persons)</span>;</span><br><span class="line"><span class="comment">//调用</span></span><br><span class="line">ArrayList&lt;Person&gt; personList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">Person person;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">    person = <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">    person.setName(<span class="string">&quot;cfanr&quot;</span>);</span><br><span class="line">    person.setAge(<span class="number">10</span> + i);</span><br><span class="line">    personList.add(person);</span><br><span class="line">&#125;</span><br><span class="line">Log.e(TAG, <span class="string">&quot;调用前：java list = &quot;</span> + personList.toString());</span><br><span class="line">Log.e(TAG, <span class="string">&quot;调用后：jni list  = &quot;</span> + paramsJni.personArrayListMethod(personList).toString());</span><br></pre></td></tr></table></figure>
<p>C++</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line"><span class="function">JNIEXPORT jobject JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_cn_cfanr_jnisample_ParamsJni_personArrayListMethod</span><span class="params">(JNIEnv *env, jobject jobj, jobject persons)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//通过参数获取 ArrayList 对象的 class</span></span><br><span class="line">    jclass clazz = env-&gt;<span class="built_in">GetObjectClass</span>(persons);</span><br><span class="line">    <span class="keyword">if</span>(clazz == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> env-&gt;<span class="built_in">NewStringUTF</span>(<span class="string">&quot;not find class&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取 ArrayList 无参数的构造函数</span></span><br><span class="line">    jmethodID constructorMid = env-&gt;<span class="built_in">GetMethodID</span>(clazz, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(constructorMid == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> env-&gt;<span class="built_in">NewStringUTF</span>(<span class="string">&quot;not find constructor method&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//new一个 ArrayList 对象</span></span><br><span class="line">    jobject arrayList = env-&gt;<span class="built_in">NewObject</span>(clazz, constructorMid);</span><br><span class="line">    <span class="comment">//获取 ArrayList 的 add 方法的id</span></span><br><span class="line">    jmethodID addMid = env-&gt;<span class="built_in">GetMethodID</span>(clazz, <span class="string">&quot;add&quot;</span>, <span class="string">&quot;(Ljava/lang/Object;)Z&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取 Person 类的 class</span></span><br><span class="line">    jclass personCls = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;cn/cfanr/jnisample/model/Person&quot;</span>);</span><br><span class="line">    <span class="comment">//获取 Person 的构造函数的 id</span></span><br><span class="line">    jmethodID personMid = env-&gt;<span class="built_in">GetMethodID</span>(personCls, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(ILjava/lang/String;)V&quot;</span>);</span><br><span class="line"></span><br><span class="line">    jint i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">        jstring name = env-&gt;<span class="built_in">NewStringUTF</span>(<span class="string">&quot;Native&quot;</span>);</span><br><span class="line">        jobject person = env-&gt;<span class="built_in">NewObject</span>(personCls, personMid, <span class="number">18</span> +i, name);</span><br><span class="line">        <span class="comment">//添加 person 到 ArrayList</span></span><br><span class="line">        env-&gt;<span class="built_in">CallBooleanMethod</span>(arrayList, addMid, person);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> arrayList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MainActivity: 调用前：<span class="type">java</span> <span class="variable">list</span> <span class="operator">=</span> [Person :&#123; name: cfanr, age: <span class="number">10</span>&#125;, Person :&#123; name: cfanr, age: <span class="number">11</span>&#125;, Person :&#123; name: cfanr, age: <span class="number">12</span>&#125;]</span><br><span class="line">MainActivity: 调用后：<span class="type">jni</span> <span class="variable">list</span>  <span class="operator">=</span> [Person :&#123; name: Native, age: <span class="number">18</span>&#125;, Person :&#123; name: Native, age: <span class="number">19</span>&#125;, Person :&#123; name: Native, age: <span class="number">20</span>&#125;]</span><br></pre></td></tr></table></figure>
<p>复杂的集合参数也是需要通过获取集合的 class 和对应的方法来调用实现的</p>
<h2 id="5-JNI-函数的字符串处理"><a href="#5-JNI-函数的字符串处理" class="headerlink" title="5. JNI 函数的字符串处理"></a>5. JNI 函数的字符串处理</h2><ul>
<li>访问字符串函数<blockquote>
<p>其中 isCopy 是取值为JNI_TRUE和JNI_FALSE（或者1，0），值为JNI_TRUE，表示返回JVM内部源字符串的一份拷贝，并为新产生的字符串分配内存空间。如果值为JNI_FALSE，表示返回JVM内部源字符串的指针，意味着可以通过指针修改源字符串的内容，不推荐这么做，因为这样做就打破了Java字符串不能修改的规定；Java默认使用Unicode编码，而C&#x2F;C++默认使用UTF编码，所以在本地代码中操作字符串的时候，必须使用合适的JNI函数把jstring转换成C风格的字符串</p>
</blockquote>
<ul>
<li>UTF-8字符：<code>const char* GetStringUTFChars(jstring string, jboolean* isCopy)</code></li>
<li>Unicode字符：<code>const jchar* GetStringChars(jstring string, jboolean* isCopy)</code></li>
</ul>
</li>
<li>释放字符串内存<ul>
<li>UTF-8字符： <code>void ReleaseStringUTFChars(jstring string, const char* utf)</code></li>
<li>Unicode 字符： <code>void ReleaseStringChars(jstring string, const jchar* chars)</code></li>
</ul>
</li>
<li>创建 String 对象，UTF-8: NewStringUTF，Unicode: NewString</li>
<li>取char*的长度，UTF-8: GetStringUTFLength，Unicode: GetStringLength</li>
<li>GetStringRegion和GetStringUTFRegion：分别表示获取Unicode和UTF-8编码字符串指定范围内的内容。这对函数会把源字符串复制到一个预先分配的缓冲区内。GetStringUTFRegion与 GetStringUTFChars 比较相似，不同的是，GetStringUTFRegion 内部不分配内存，不会抛出内存溢出异常。</li>
</ul>
<p>代码示例就不写了，其他详细可参考：<br><a class="link"   target="_blank" rel="noopener" href="http://blog.csdn.net/honjane/article/details/53965966" >JNI开发之旅（9）JNI函数字符串处理 - 猫的阁楼 - CSDN博客<i class="fas fa-external-link-alt"></i></a><br><a class="link"   target="_blank" rel="noopener" href="http://blog.csdn.net/xyang81/article/details/42066665" >JNI&#x2F;NDK开发指南（四）——字符串处理 - 技术改变生活- CSDN博客<i class="fas fa-external-link-alt"></i></a></p>
<h2 id="6-动态注册-JNI"><a href="#6-动态注册-JNI" class="headerlink" title="6. 动态注册 JNI"></a>6. 动态注册 JNI</h2><p>学了上面的练习，发现静态注册的方式还是挺麻烦的，生成的 JNI 函数名太长，文件、类名、变量或方法重构时，需要重新修改头文件或 C&#x2F;C++ 内容代码（而且还是各个函数都要修改，没有一个统一的地方），动态注册 JNI 的方法就可以解决这个问题。</p>
<p>由上篇回顾下，<a class="link"   target="_blank" rel="noopener" href="http://cfanr.cn/2017/07/29/Android-NDK-dev-JNI-s-foundation/" >Android NDK开发：JNI基础篇 | cfanr<i class="fas fa-external-link-alt"></i></a><br><strong>动态注册 JNI 的原理：直接告诉 native 方法其在JNI 中对应函数的指针</strong>。通过使用 JNINativeMethod 结构来保存 Java native 方法和 JNI 函数关联关系，步骤：</p>
<ul>
<li>先编写 Java 的 native 方法；</li>
<li>编写 JNI 函数的实现（函数名可以随便命名）；</li>
<li>利用结构体 JNINativeMethod 保存Java native方法和 JNI函数的对应关系；</li>
<li>利用<code>registerNatives(JNIEnv* env)</code>注册类的所有本地方法；</li>
<li>在 JNI_OnLoad 方法中调用注册方法；</li>
<li>在Java中通过System.loadLibrary加载完JNI动态库之后，会自动调用JNI_OnLoad函数，完成动态注册；</li>
</ul>
<p>代码实例：<br>native 方法和调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicRegisterJni</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">getStringFromCpp</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//调用</span></span><br><span class="line"><span class="type">String</span> <span class="variable">hello</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DynamicRegisterJni</span>().getStringFromCpp();</span><br><span class="line">Log.e(TAG, hello);</span><br></pre></td></tr></table></figure>

<p>C++动态注册 JNI 代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;android/log.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> LOG_TAG</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_TAG <span class="string">&quot;JNI_LOG&quot;</span> <span class="comment">//Log 的 tag 名字</span></span></span><br><span class="line"><span class="comment">//定义各种类型 Log 的函数别名</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGD(...) __android_log_print(ANDROID_LOG_DEBUG,LOG_TAG ,__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGI(...) __android_log_print(ANDROID_LOG_INFO,LOG_TAG ,__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGW(...) __android_log_print(ANDROID_LOG_WARN,LOG_TAG ,__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGE(...) __android_log_print(ANDROID_LOG_ERROR,LOG_TAG ,__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGF(...) __android_log_print(ANDROID_LOG_FATAL,LOG_TAG ,__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">//定义类名</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> *className = <span class="string">&quot;cn/cfanr/jnisample/DynamicRegisterJni&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义对应Java native方法的 C++ 函数，函数名可以随意命名</span></span><br><span class="line"><span class="function"><span class="type">static</span> jstring <span class="title">sayHello</span><span class="params">(JNIEnv *env, jobject)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">LOGI</span>(<span class="string">&quot;hello, this is native log.&quot;</span>);</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* hello = <span class="string">&quot;Hello from C++.&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> env-&gt;<span class="built_in">NewStringUTF</span>(hello);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 定义函数映射表（是一个数组，可以同时定义多个函数的映射）</span></span><br><span class="line"><span class="comment"> * 参数1：Java 方法名</span></span><br><span class="line"><span class="comment"> * 参数2：方法描述符，也就是签名</span></span><br><span class="line"><span class="comment"> * 参数3：C++定义对应 Java native方法的函数名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> JNINativeMethod jni_Methods_table[] = &#123;</span><br><span class="line">        &#123;<span class="string">&quot;getStringFromCpp&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>, (<span class="type">void</span> *) sayHello&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//根据函数映射表注册函数</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">registerNativeMethods</span><span class="params">(JNIEnv *env, <span class="type">const</span> <span class="type">char</span> *className,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="type">const</span> JNINativeMethod *gMethods, <span class="type">int</span> numMethods)</span> </span>&#123;</span><br><span class="line">    jclass clazz;</span><br><span class="line">    <span class="built_in">LOGI</span>(<span class="string">&quot;Registering %s natives\n&quot;</span>, className);</span><br><span class="line">    clazz = (env)-&gt;<span class="built_in">FindClass</span>(className);</span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;Native registration unable to find class &#x27;%s&#x27;\n&quot;</span>, className);</span><br><span class="line">        <span class="keyword">return</span> JNI_ERR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((env)-&gt;<span class="built_in">RegisterNatives</span>(clazz, gMethods, numMethods) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;Register natives failed for &#x27;%s&#x27;\n&quot;</span>, className);</span><br><span class="line">        <span class="keyword">return</span> JNI_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//删除本地引用</span></span><br><span class="line">    (env)-&gt;<span class="built_in">DeleteLocalRef</span>(clazz);</span><br><span class="line">    <span class="keyword">return</span> JNI_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM *vm, <span class="type">void</span> *reserved)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">LOGI</span>(<span class="string">&quot;call JNI_OnLoad&quot;</span>);</span><br><span class="line"></span><br><span class="line">    JNIEnv *env = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (vm-&gt;<span class="built_in">GetEnv</span>((<span class="type">void</span> **) &amp;env, JNI_VERSION_1_4) != JNI_OK) &#123;  <span class="comment">//判断 JNI 版本是否为JNI_VERSION_1_4</span></span><br><span class="line">        <span class="keyword">return</span> JNI_EVERSION;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">registerNativeMethods</span>(env, className, jni_Methods_table, <span class="built_in">sizeof</span>(jni_Methods_table) / <span class="built_in">sizeof</span>(JNINativeMethod));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JNI_VERSION_1_4;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p> 输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">JNI_LOG: call JNI_OnLoad</span><br><span class="line">JNI_LOG: Registering cn/cfanr/jnisample/DynamicRegisterJni natives</span><br><span class="line">JNI_LOG: hello, this is native log.</span><br><span class="line">MainActivity: Hello from C++.</span><br></pre></td></tr></table></figure>

<p>上面代码涉及到 <strong>JNI 调用 Android 的 Log</strong>，只需要引入<code>#include &quot;android/log.h&quot;</code>头文件和对函数别名命名即可。其他具体说明见上面代码。</p>
<p>实际开发中可以<strong>采取动态和静态注册结合的方式</strong>，写一个Java 的 native 方法完成调用动态注册的代码，大概代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">   System.loadLibrary(<span class="string">&quot;native-lib&quot;</span>);</span><br><span class="line">    registerNatives();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">registerNatives</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>
<p>C++</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JNIEXPORT <span class="type">void</span> JNICALL <span class="title">Java_com_zhixin_jni_JniSample_registerNatives</span></span></span><br><span class="line"><span class="function"><span class="params">(JNIEnv *env, jclass clazz)</span></span>&#123;</span><br><span class="line">     (env)-&gt;<span class="built_in">RegisterNatives</span>(clazz, gJni_Methods_table, <span class="built_in">sizeof</span>(gJni_Methods_table) / <span class="built_in">sizeof</span>(JNINativeMethod));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-小结"><a href="#7-小结" class="headerlink" title="7. 小结"></a>7. 小结</h2><p>虽然都是按照网上的例子做的练习记录，但还是遇到不少小问题的，不过只要仔细查找，也比较容易发现问题的所在，以前觉得 JNI 挺难懂的，但这次练习下来，觉得 JNI 也只不过是一套语法规则而已，按照规则去实现代码也不算特别难，<strong>当然这只是 JNI 的一小部分内容，JNI 还有很多内容，如反射、异常处理、多线程、NIO 等</strong>。虽然这次练习比较简单，但建议还是自己亲自敲一遍代码，在练习中发现问题，并解决，以后遇到同类型的问题也比较容易解决。</p>
<p>注意一些报错的问题：</p>
<ul>
<li>如果没加 extern “C” 或者 没将 C&#x2F;C++ 文件配置到  CMake 文件上，可能会报<code>java.lang.UnsatisfiedLinkError: Native method not found:  xxx </code>错误</li>
<li>一般报<code>java.lang.NoSuchMethodError: no method with xxx</code>错误，可能是因为 class  和方法不对应，<code>env-&gt;GetObjectClass( jobject jobj) </code>这里用错了对象</li>
<li>报<code>java.lang.NoClassDefFoundError</code>，可能是类名写错找不到类；</li>
</ul>
<p>本文完整代码可以到 GitHub 查看源码： <a class="link"   target="_blank" rel="noopener" href="https://github.com/navyifanr/AndroidTrainingDemo/tree/master/JNISample" >AndroidTrainingDemo&#x2F;JNISample<i class="fas fa-external-link-alt"></i></a></p>
<p>参考资料：<br><a class="link"   target="_blank" rel="noopener" href="http://blog.csdn.net/column/details/honjane.html" >专栏：JNI开发之旅 -猫的阁楼- CSDN博客<i class="fas fa-external-link-alt"></i></a><br><a class="link"   target="_blank" rel="noopener" href="http://zhixinliu.com/2015/07/01/2015-07-01-jni-register/" >Andoid NDK编程1- 动态注册native函数 &#x2F;&#x2F; Coding Life<i class="fas fa-external-link-alt"></i></a><br><a class="link"   target="_blank" rel="noopener" href="http://www.jianshu.com/p/acbf724fdcc9" >Android Stuido Ndk-Jni 开发：Jni中打印log信息 - 简书<i class="fas fa-external-link-alt"></i></a></p>

        </div>

        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/Android-NDK/">#Android NDK</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2017/08/19/Android-NDK-dev-practice-samples/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Android NDK 开发：实战案例</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2017/07/29/Android-NDK-dev-JNI-s-foundation/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Android NDK开发：JNI基础篇</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">cfanr</a>
        </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    

    <div class="image-viewer-container">
    <img src="">
</div>


    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>








<div class="post-scripts">
    
</div>



</body>
</html>
